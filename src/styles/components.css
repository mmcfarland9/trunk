/* === Shared === */
.focus-meta, .editor-label {
  font-size: 0.85rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--ink-faint);
}

/* === Buttons === */
.action-button, .panel-button, .editor-clear, .editor-cancel, .editor-save {
  border: none;
  background: transparent;
  color: var(--ink-faint);
  font-family: var(--font-body);
  font-weight: 500;
  cursor: pointer;
  transition: color 200ms ease;
}

.action-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.5rem 0.75rem;
  font-size: 0.8rem;
}

.action-button:hover, .action-button:focus-visible,
.panel-button:hover:not(:disabled), .panel-button:focus-visible,
.editor-clear:hover, .editor-clear:focus-visible,
.editor-cancel:hover, .editor-cancel:focus-visible { color: var(--ink); outline: none; }

.action-button.secondary { opacity: 0.7; }

.panel-button { width: 100%; padding: 0.5rem 0; font-size: 0.8rem; text-align: left; }
.panel-button:disabled { cursor: default; opacity: 0.4; }

/* === Nodes === */
.node {
  position: absolute;
  transform: translate(-50%, -50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  appearance: none;
  font-family: var(--font-ascii);
  font-size: var(--char);
  line-height: 1.2;
  background: transparent;
  color: var(--ink-faint);
  border: none;
  padding: 0;
  cursor: pointer;
  transition: color 180ms ease;
  text-align: center;
  white-space: pre;
}

.node:hover, .node:focus-visible { color: var(--ink); outline: none; }
.node.is-focused, .node.is-active { color: var(--ink); }
.canvas.is-zooming .node { transition-duration: 480ms; }
/* Locked panel - trunk/branch not clickable */
.canvas.is-panel-locked .node.trunk,
.canvas.is-panel-locked .node.branch { cursor: default; }

/* Branch */
.node.branch { position: relative; line-height: 1; }
.node.branch::before, .node.branch::after { display: block; opacity: 0.5; }
.node.branch::before { content: attr(data-top-border); }
.node.branch::after { content: attr(data-bottom-border); }
.node.branch .node-label {
  display: inline-block;
  padding: 0;
  font-family: var(--font-display);
  font-size: calc(var(--char) * 1.05);
  line-height: 1;
  white-space: pre;
}
.node.branch[data-label-lines='2'] .node-label { font-size: calc(var(--char) * 1); }
.node.branch[data-label-lines='3'] .node-label { font-size: calc(var(--char) * 0.95); }
.node.branch:hover::before, .node.branch:hover::after,
.branch-group.is-preview .node.branch::before, .branch-group.is-preview .node.branch::after { opacity: 0.8; }
.node.branch[data-filled='true'] { color: var(--wood); }
.branch-group.is-preview .node.branch { color: var(--ink); }
.node.branch[data-filled='true']::before, .node.branch[data-filled='true']::after { opacity: 0.7; }

/* Leaf */
.leaf { min-width: 2ch; min-height: 1.2em; opacity: 1; transition: opacity 1200ms ease-out, transform 200ms ease-out; }
.leaf.is-updating { opacity: 0; transform: scale(0.95); }
.leaf .node-label { display: block; }
.leaf[data-filled='false'] .node-label { display: none; }
/* Parentheses only show in branch view (zoomed in) */
.canvas.is-zoomed .leaf[data-filled='false']::before { content: "( )"; }
.canvas.is-zoomed .leaf:hover[data-filled='false']::before { content: "(*)"; color: var(--ink); }
/* Hidden leaves (overview, not previewing) */
.leaf.is-hidden { opacity: 0; pointer-events: none; }
.leaf.is-hidden .node-label { visibility: hidden; }
/* Fading out leaves (exiting preview) - keep preview appearance while fading */
.leaf.is-fading { opacity: 0; pointer-events: none; transition: opacity var(--fade-duration, 1000ms) ease-out; transition-delay: var(--fade-delay, 0ms); min-width: 0; min-height: 0; }
.leaf.is-fading .node-label { display: none; }
.leaf.is-fading::before { content: "."; font-size: calc(var(--char) * 0.9); }
.leaf.is-fading::after { content: none; }
.leaf.is-fading[data-filled='true']::before { content: "*"; color: var(--leaf); font-size: calc(var(--char) * 1.2); }
/* Preview mode - show only dots/asterisks */
.branch-group.is-preview .leaf { min-width: 0; min-height: 0; opacity: 1; }
.branch-group.is-preview .leaf .node-label { display: none; }
.branch-group.is-preview .leaf::before { content: "."; font-size: calc(var(--char) * 0.9); opacity: 1; }
.branch-group.is-preview .leaf::after { content: none; }
.branch-group.is-preview .leaf[data-filled='true']::before { content: "*"; color: var(--leaf); font-size: calc(var(--char) * 1.2); }
.canvas.is-previewing .branch-group.is-preview .leaf { transition: opacity 250ms ease-out; }
/* Filled leaf in branch view - show full ASCII box */
.canvas.is-zoomed .branch-group.is-active .leaf[data-filled='true'] { color: var(--leaf); font-size: calc(var(--char) * 0.7); line-height: 1; }
.canvas.is-zoomed .branch-group.is-active .leaf[data-filled='true']::before { content: attr(data-top-border); display: block; }
.canvas.is-zoomed .branch-group.is-active .leaf[data-filled='true']::after { content: attr(data-bottom-border); display: block; }
.canvas.is-zoomed .branch-group.is-active .leaf[data-filled='true'][data-label-lines='2'] { font-size: calc(var(--char) * 0.65); }
.canvas.is-zoomed .branch-group.is-active .leaf[data-filled='true'][data-label-lines='3'] { font-size: calc(var(--char) * 0.6); }
/* In branch view, leaves appear instantly (no fade) */
.canvas.is-zoomed .branch-group.is-active .leaf { transition: transform 200ms ease-out; }
.canvas.is-zooming .branch-group.is-active .leaf { transition: opacity 480ms ease-out, transform 200ms ease-out; transition-delay: var(--leaf-delay, 0ms); }

/* Trunk */
.node.trunk { left: 50%; top: 50%; z-index: 5; color: var(--wood); transition: color 320ms ease; line-height: 1; }
.node.trunk .trunk-title { text-transform: uppercase; letter-spacing: 0.15em; font-family: var(--font-display); font-size: calc(var(--char) * 1.2); }
.node.trunk.is-minimized { left: var(--minimized-x, 50%); top: var(--minimized-y, 50%); opacity: 0.7; }
.node.trunk.is-minimized .trunk-title { font-size: 0; }
.node.trunk.is-minimized .trunk-title::before { content: "*"; font-size: calc(var(--char) * 4); }
.node.trunk.is-minimized:hover { opacity: 1; }

/* === Side Panel === */
.side-panel { display: flex; flex-direction: column; gap: 1rem; animation: fade-in 600ms ease 100ms both; font-family: var(--font-ascii); font-size: 12px; }
.panel-section { padding: 0.75rem 0; }
.panel-section.is-empty { display: none; }
.focus-meta { margin: 0 0 0.5rem; height: 1.4em; }
.focus-title, .focus-note { margin: 0; color: var(--ink); line-height: 1.5; overflow: hidden; text-overflow: ellipsis; }
.focus-title { font-weight: 400; margin-bottom: 0.4rem; height: 1.5em; }
.focus-note { color: var(--ink-light); max-height: 3em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
.focus-goal { margin: 0.25rem 0 0; color: var(--ink-light); height: 1.5em; font-style: italic; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.focus-title.is-muted, .focus-note.is-muted, .focus-goal.is-muted { color: var(--ink-faint); }
.period-section { padding: 0.25rem 0 0; }
.period-date { margin: 0.5rem 0 0.25rem; font-size: 0.85rem; color: var(--ink); }
.period-selector { display: flex; gap: 0.5rem; font-family: var(--font-ascii); }
.period-btn { background: transparent; border: none; padding: 0; font-family: inherit; font-size: 0.8rem; color: var(--ink-faint); cursor: pointer; }
.period-start-btn { margin-top: 0.5rem; padding: 0.4rem 0.75rem; font-family: var(--font-ascii); font-size: 0.8rem; background: transparent; border: 1px solid var(--border-strong); color: var(--ink); cursor: pointer; }
.period-start-btn:hover { border-color: var(--ink); }
.period-btn::before { content: '['; visibility: hidden; }
.period-btn::after { content: ']'; visibility: hidden; }
.period-btn.is-active { color: var(--ink); }
.period-btn.is-active::before, .period-btn.is-active::after { visibility: visible; }
.progress-count { margin: 0 0 0.75rem; color: var(--ink); font-weight: 400; min-height: 3.6em; line-height: 1.2; }
.progress-track { width: 100%; height: 12px; background: transparent; border: 1px solid var(--border); overflow: hidden; }
.progress-fill { display: block; height: 100%; background: var(--leaf); opacity: 0.3; transition: width 300ms ease; }
.progress-actions { margin-top: 1rem; }
.branch-progress { margin-top: 0.75rem; display: none; flex-direction: column; gap: 0; }
.branch-progress.has-content { display: flex; }
.branch-item { display: grid; grid-template-columns: 1fr auto; gap: 0.25rem; background: transparent; border: none; padding: 0.35rem 0.5rem; margin: 0 -0.5rem; text-align: left; cursor: pointer; transition: all 150ms ease; }
.branch-item:hover { background: rgba(0, 0, 0, 0.04); }
.branch-item.is-current .branch-label { color: var(--leaf); }
.branch-item:hover .branch-label { color: var(--wood); }
.branch-label { font-weight: 400; color: var(--ink-faint); transition: color 150ms ease; text-decoration: underline; text-decoration-color: transparent; text-underline-offset: 2px; pointer-events: none; }
.branch-item:hover .branch-label { text-decoration-color: var(--wood); }
.branch-item.is-labeled .branch-label { color: var(--ink); }
.branch-count { font-size: 0.75rem; color: var(--ink-faint); align-self: center; pointer-events: none; }
.status-message { margin: 0 0 0.2rem; font-size: 0.8rem; color: var(--ink-faint); }
.status-message[data-tone='success'] { color: var(--success-tone); }
.status-message[data-tone='warning'] { color: var(--warning-tone); }
.status-message[data-tone='error'] { color: var(--error-tone); }
.status-meta { margin: 0; font-size: 0.75rem; color: var(--ink-faint); opacity: 0.7; }

/* === Editor === */
.node-editor { position: fixed; transform: translate(-50%, -100%); min-width: 240px; max-width: 300px; background: var(--paper); box-shadow: 0 8px 40px rgba(0, 0, 0, 0.12); padding: 1.25rem; z-index: 1000; opacity: 1; transition: opacity 150ms ease; overflow: visible; }
.node-editor.hidden { opacity: 0; pointer-events: none; }
.editor-close-btn { position: absolute; top: 0.25rem; right: 0.25rem; width: 1.25rem; height: 1.25rem; padding: 0; background: transparent; border: none; font-family: var(--font-ascii); font-size: 0.9rem; line-height: 1; color: var(--ink-faint); cursor: pointer; opacity: 0.5; transition: opacity 150ms ease, color 150ms ease; }
.editor-close-btn:hover { opacity: 1; color: var(--ink); }
.editor-card { display: flex; flex-direction: column; gap: 0.75rem; margin: 0; }
.editor-label { display: flex; flex-direction: column; gap: 0.35rem; }
.editor-input, .editor-textarea { width: 100%; border: none; border-bottom: 1px solid var(--border-strong); background: transparent; color: var(--ink); padding: 0.5rem 0; font-family: var(--font-body); font-size: 0.9rem; resize: vertical; min-height: 36px; }
.editor-input:focus, .editor-textarea:focus { outline: none; border-color: var(--wood); }
.editor-input.is-locked { border-bottom-color: transparent; color: var(--ink-light); cursor: default; }
.editor-actions { display: flex; justify-content: space-between; gap: 0.5rem; margin-top: 0.25rem; }
.editor-clear, .editor-cancel, .editor-save { padding: 0.4rem 0; font-size: 0.8rem; }
.editor-goal-section { display: flex; flex-direction: column; gap: 0.5rem; position: relative; }
.editor-goal-section::before { content: attr(data-tooltip); position: absolute; right: 100%; top: 50%; transform: translateY(-50%); margin-right: 1.5rem; padding: 0.2rem 0.5rem; font-size: 0.6rem; font-style: italic; line-height: 1.15; color: var(--ink); background: var(--paper); border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.1); white-space: pre-line; opacity: 0; pointer-events: none; transition: opacity 150ms ease; z-index: 10; }
.editor-goal-section.is-locked:has(.editor-goal-binary:hover, .editor-goal-continuous:hover, .goal-submit-btn:hover)::before { opacity: 1; }
.goal-type-toggle { display: flex; gap: 0; border: 1px solid var(--border-strong); }
.goal-type-btn { flex: 1; padding: 0.35rem 0.5rem; font-size: 0.75rem; font-family: var(--font-ascii); background: transparent; border: none; color: var(--ink-faint); cursor: pointer; transition: all 150ms ease; }
.goal-type-btn:first-child { border-right: 1px solid var(--border-strong); }
.goal-type-btn.is-active { background: var(--ink); color: var(--paper); }
.editor-goal-binary, .editor-goal-continuous { min-height: 2.5rem; cursor: pointer; padding: 0.5rem 0; }
.editor-goal-section.is-locked .editor-goal-binary, .editor-goal-section.is-locked .editor-goal-continuous, .editor-goal-section.is-locked .goal-submit-btn { opacity: 0.55; }
.editor-goal-section.is-locked .result-btn, .editor-goal-section.is-locked .editor-slider { pointer-events: none; }
.editor-goal-section.is-locked .goal-submit-btn { cursor: default; }
.editor-goal-binary { flex-direction: column; gap: 0.5rem; }
.editor-goal-continuous { flex-direction: column; gap: 0.65rem; }
.goal-result-selector { display: flex; gap: 1.5rem; font-family: var(--font-ascii); }
.result-btn { background: transparent; border: none; padding: 0; font-family: inherit; font-size: 0.8rem; color: var(--ink-faint); cursor: pointer; }
.result-btn::before { content: '['; visibility: hidden; }
.result-btn::after { content: ']'; visibility: hidden; }
.result-btn.is-active { color: var(--ink); }
.result-btn.is-active::before, .result-btn.is-active::after { visibility: visible; }
.goal-slider-row { display: flex; align-items: center; gap: 0.5rem; }
.editor-slider { flex: 1; height: 0.5rem; cursor: pointer; appearance: none; background: var(--border-strong); }
.editor-slider::-webkit-slider-thumb { appearance: none; width: 1rem; height: 1rem; background: var(--ink); cursor: pointer; }
.goal-value { font-size: 0.8rem; min-width: 2.5rem; text-align: right; color: var(--ink-light); }
.goal-actions { display: flex; gap: 0.5rem; }
.goal-action-btn { flex: 1; padding: 0.4rem 0.5rem; font-size: 0.75rem; font-family: var(--font-ascii); border: 1px solid var(--border-strong); background: transparent; color: var(--ink); cursor: pointer; }
.goal-action-btn:disabled { color: var(--ink-faint); cursor: default; }
.editor-save { color: var(--ink); }
.editor-save:hover, .editor-save:focus-visible { color: var(--leaf); outline: none; }

/* Goal History Panel */
.goal-history-panel { position: absolute; top: 0; left: 100%; width: 200px; height: 100%; background: var(--paper); box-shadow: 4px 0 20px rgba(0, 0, 0, 0.08); padding: 1.25rem; transform: translateX(-100%); opacity: 0; pointer-events: none; transition: transform 200ms ease, opacity 200ms ease; }
.goal-history-panel.is-open { transform: translateX(0); opacity: 1; pointer-events: auto; }
.goal-history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.1em; color: var(--ink-faint); }
.goal-history-close { background: transparent; border: none; font-size: 1.25rem; color: var(--ink-faint); cursor: pointer; padding: 0; line-height: 1; }
.goal-history-close:hover { color: var(--ink); }
.goal-history-content { font-size: 0.85rem; color: var(--ink-light); }
.goal-history-empty { margin: 0; font-style: italic; color: var(--ink-faint); }
